# Askama Filters

## When to Use This Reference

- Using built-in filters like `escape`, `safe`, `trim`
- Creating custom filters for reusable transformations
- Need to understand when `safe` filter is appropriate
- Filter not working — debugging filter scope issues

## Quick Reference

| Filter | Usage | Note |
|--------|-------|------|
| `escape` / `e` | `{{ value \| escape }}` | Force escaping (default behavior anyway) |
| `safe` | `{{ html \| safe }}` | Bypass escaping — use with caution |
| `trim` | `{{ value \| trim }}` | Remove whitespace |
| `lower` | `{{ value \| lower }}` | Lowercase |
| `upper` | `{{ value \| upper }}` | Uppercase |
| `format` | `{{ value \| format("{:.2}") }}` | Rust format string |

## The Rule

Askama escapes HTML by default for security. The `safe` filter bypasses this protection.

**Only use `safe` for content you control.** Never use it on user input.

Safe uses of `safe`:
- Pre-rendered HTML from your own templates
- Markdown rendered by a trusted library
- Static HTML fragments you wrote

Dangerous uses of `safe`:
- User comments or input
- Data from external APIs
- Anything not generated by your code

## Patterns

### The `safe` Filter — Correct Usage

**Pre-rendered template content:**
```rust
let inner_html = InnerTemplate { item }.render()?;
let outer = OuterTemplate { content: inner_html };
```

```html
<!-- Safe: we rendered this ourselves -->
{{ content | safe }}
```

**Markdown rendering:**
```rust
let rendered = markdown::to_html(&trusted_markdown);
MyTemplate { body: rendered }
```

```html
<!-- Safe: rendered from our markdown files -->
{{ body | safe }}
```

### Custom Filters

Custom filters go in a `filters` module in scope of your Template struct.

**Basic filter:**
```rust
mod filters {
    pub fn format_currency(cents: &i32) -> askama::Result<String> {
        Ok(format!("${}.{:02}", cents / 100, cents.abs() % 100))
    }
}

#[derive(Template)]
#[template(path = "receipt.html")]
struct Receipt {
    total_cents: i32,
}
```

```html
<span class="total">{{ total_cents | format_currency }}</span>
```

**Filter with arguments:**
```rust
mod filters {
    pub fn pluralize(count: &i32, singular: &str, plural: &str) -> askama::Result<String> {
        Ok(if *count == 1 {
            singular.to_string()
        } else {
            plural.to_string()
        })
    }
}
```

```html
{{ count }} {{ count | pluralize("item", "items") }}
```

### Filter Chaining

```html
{{ value | trim | lower }}
{{ name | escape | safe }}  <!-- Escape then mark safe (unusual but valid) -->
```

## Common Mistakes

| Mistake | Consequence | Fix |
|---------|-------------|-----|
| `{{ user_input \| safe }}` | XSS vulnerability | Never use safe on user data |
| Filter module not in scope | "cannot find function" | Move filter module to Template's module |
| Wrong return type | Compile error | Return `askama::Result<String>` |
| Missing argument reference | Compile error | First arg is `&T`, not `T` |

## The `safe` Anti-Pattern

**Never do this:**
```html
<!-- Vulnerable to XSS -->
{{ comment.body | safe }}
{{ api_response.html | safe }}
{{ user.bio | safe }}
```

**Do this instead:**
```html
<!-- Let Askama escape automatically -->
{{ comment.body }}
{{ api_response.text }}
{{ user.bio }}
```

If you truly need HTML in user content, use an allowlist-based sanitizer like `ammonia` before storing, not `safe` at render time.

## Resources

- [Askama Filters Reference](https://askama.readthedocs.io/en/stable/filters.html)
- [Built-in Filters List](https://docs.rs/askama/latest/askama/filters/index.html)
- [OWASP XSS Prevention](https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html)
